<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">

<style>
a {
	text-decoration: none;
}
</style>
</head>
<body onload="drawStartScreen()">
<div style="text-align: center">
<canvas id="canvas" width="500" height="300" style="background-color:#FFF; border: 1px solid black">
</canvas>

<script>
// VARIABLEN
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
xmid = canvas.width / 2;
ymid = canvas.height / 2;
var mode;
var spielStartZ = 0;
var spielEndZ = 0;
var winner = "";
var justTurned = false;

// OBJEKTE
var ball = {
	x: 0,
	y: 0,
	vx: 5,
	vy: 2,
	radius: 15,
	draw: function() {
		ctx.fillStyle = 'red';
		ctx.beginPath();
		ctx.arc(this.x, this.y, this.radius ,0, Math.PI*2);
		ctx.fill();
	}
};

var playerOne = {
	x: 5,
	y: 5,
	speed: 20,
	width: 10,
	height: 100,
	style: "#FFF",
	count: 0,
	score: 0,
	draw: function () {
		ctx.beginPath();
		ctx.fillStyle = this.style;
		ctx.rect(this.x,this.y, this.width, this.height); 
		ctx.fill();
	}
};

var playerTwo = {
	x: 5,
	y: 5,
	speed: 20,
	width: 10,
	height: 100,
	style: "#FFF",
	count: 0,
	score: 0,
	draw: function () {
		ctx.beginPath();
		ctx.fillStyle = this.style;
		ctx.rect(this.x,this.y, this.width, this.height); 
		ctx.fill();
	}
};

// EVENTS
document.addEventListener('keydown', keyDownHandler);


// FUNKTIONEN

function init() {
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.save();
	winner = "";
	ball.x = xmid;
	ball.y = ymid;
	playerOne.count = 0;
	playerTwo.count = 0;
	playerOne.x = 5;
	playerOne.y = ymid - (playerOne.height / 2);
	playerTwo.x = canvas.width - playerTwo.width - playerOne.x;
	playerTwo.y = ymid - (playerTwo.height / 2);
	mode = "game";
	console.log('Start');
	spielStartZ = Date.now();
	// Ball Flugrichtung per Zufall
	if(getRandomInt(1,2) == 2) { 
		ball.vx = -(ball.vx);
	}
	if(getRandomInt(1,2) == 2) { 
		ball.vy = -(ball.vy);
	}
	window.requestAnimationFrame(drawGame);
}


function drawGame() {
	mode = "game";
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	
	// Spielfeld
	drawGameField();
	
	//Player	
	playerOne.draw();
	playerTwo.draw();
	
	// Kollision mit PayerOne (links)
	if((ball.x - ball.radius) <= (playerOne.x + playerOne.width) && ball.y >= playerOne.y && ball.y <=(playerOne.y + playerOne.height) && ball.vx < 0) {
		ball.vx = -(ball.vx);
		//console.log("HIT Links VX="+ball.vx);
		playerOne.count++;

	}
	
	// Kollision mit PayerTwo (rechts)
	if((ball.x + ball.radius) >= playerTwo.x && ball.y >= playerTwo.y && ball.y <=playerTwo.y+playerTwo.height && ball.vx > 0) {
		ball.vx = -(ball.vx);
		//console.log("HIT Rechts VX="+ball.vx);
		playerTwo.count++;
	
	} 

	//Kollision mit Oben und Unten bzw game over
	if((ball.y - ball.radius) < 0 || (ball.y + ball.radius) > canvas.height) ball.vy = -(ball.vy);
	
	if((ball.x - ball.radius) < 0 || (ball.x + ball.radius) > canvas.width) {
		//Players Score
		if((ball.x - ball.radius) < 0) { 
			playerTwo.score+=1;
			winner = "Player Two";
		} else if((ball.x + ball.radius) > canvas.width) {
			playerOne.score+=1;
			winner = "Player One";
		}
		console.log("Game Over");
		cancelAnimationFrame(drawGame);
		spielEndZ = Date.now();
		drawScoreScreen();
		return false;
	}
	
	
	//Zeichnen Kreis
	ball.x += ball.vx;
	ball.y += ball.vy;
		
	ball.draw();	
	
	window.requestAnimationFrame(drawGame);		
}

function drawScoreScreen() {
	mode = "score";

	drawGameField();
		
	ctx.fillStyle = 'red';
	ctx.font = "25px 'Calibri'";
	ctx.textBaseline="middle";
	ctx.textAlign="center";
	ctx.fillText("Game Over", xmid,ymid-100);
	
	ctx.fillStyle = '#336699';
	ctx.font = "27px 'Calibri'";
	ctx.fillText(winner+ " won!", xmid,ymid-60);
	
	ctx.fillStyle = '#FFF';
	ctx.font = "15px 'Calibri'";
	ctx.textBaseline="middle";
	ctx.textAlign="center";
	ctx.fillText("Player One vs. Player Two", xmid,ymid+40);
	ctx.fillText("Score: "+playerOne.score+" : " +playerTwo.score, xmid,ymid+55);
	ctx.fillText("Hits: "+playerOne.count+" : " +playerTwo.count, xmid,ymid+70);
	
	ctx.fillText("Duration: "+ calcSpielzeit(), xmid, ymid+85);
	ctx.fillText("Hit [RETURN] to start again!", xmid, ymid+120);
	window.requestAnimationFrame(drawScoreScreen);
}

function drawStartScreen() {
	mode = "start";
	
	drawGameField();
		
	ctx.fillStyle = 'red';
	ctx.font = "25px 'Calibri'";
	ctx.textBaseline="middle";
	ctx.textAlign="center";
	ctx.fillText("Welcome to Pong", xmid,ymid-100);
	
	ctx.fillStyle = '#FFF';
	ctx.font = "15px 'Calibri'";
	ctx.textBaseline="middle";
	ctx.textAlign="left";
	ctx.fillText("Player One: use 'w' for up and 's' for down.", 20,ymid-40);
	ctx.fillText("Player Two: use 'numpad 8' for up and 'numpad 5' for down.", 20,ymid-25);
	
	ctx.textAlign="center";
	ctx.fillText("Hit [RETURN] to start!", xmid, ymid+120);
	window.requestAnimationFrame(drawStartScreen);
}

function drawGameField() {
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.beginPath();
	ctx.fillStyle = "#333";
	ctx.rect(0,0,canvas.width,canvas.height);
	ctx.fill();
}

function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min +1)) + min; 
} 

function keyDownHandler(e) {
	
  switch(e.code) {
	case 'KeyW': // P1 hoch bewegen
		if(playerOne.y>0) playerOne.y-=playerOne.speed;
		break;
	case 'KeyS': // P1 runter bewegen
		if((playerOne.y + playerOne.height) < canvas.height) playerOne.y+=playerOne.speed;
		break;
	case 'Numpad8':
		if(playerTwo.y > 0 ) playerTwo.y-=playerTwo.speed;
		break;
	case 'Numpad5':
		if((playerTwo.y + playerTwo.height)< canvas.height) playerTwo.y+=playerTwo.speed;
		break;
	case 'Enter':
		if (mode != "game") {
			cancelAnimationFrame(drawScoreScreen);	
			cancelAnimationFrame(drawStartScreen);	
			init();
		}
	default:
	}
}

function calcSpielzeit() {
	
	return Math.round((spielEndZ - spielStartZ) / 1000) + " sec";
}

</script>

</div>

</body>
</html>